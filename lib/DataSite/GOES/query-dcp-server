#!/bin/sh

hrs="$1"
test -n "$hrs" ||
    hrs=1

dcpid=$(<@DCPID)
tob ..validate-dcpid $dcpid ||
    exit 2

w3m -dump -cols 10000 "http://lrgseddn1.cr.usgs.gov/cgi-bin/fieldtest.pl?DCPID=$dcpid&SINCE=$hrs" \
    > @results

lines=$(wc -l @results)
lines=${lines% *}

loginfo="id=$dcpid,lines=$lines"

test -n "$USER" &&
    loginfo="$loginfo,user=$USER"

tob ingest/log.store $loginfo

# store a last-ditch flat file of log messages and results:
now=$(date --iso=seconds)
# define a prefix for separate files by month:
ym=$(date +%Y-%m)
echo \#query: $now,$loginfo >> ingest/@$ym-alldata
cat @results >> ingest/@$ym-alldata

