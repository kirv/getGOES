#!/bin/sh

hrs="$1"
test -n "$hrs" || hrs=1

dcpid=$(<@DCPID)

cd ingest || exit 1

# prior to May2010:
# "http://lrgseddn1.cr.usgs.gov/cgi-bin/fieldtest.pl?DCPID=$dcpid&SINCE=$hrs"
# 
# as of 03may2010:
# "http://lrgseddn3.cr.usgs.gov/cgi-bin/fieldtest.pl?DCPID=326AF6FE&SINCE=8"
#
# EDDN home page: http://eddn.usgs.gov/
# DCP Field Test - Low-Bandwidth Message Access:
#       http://eddn.usgs.gov/fieldtest.html


server=lrgseddn3.cr.usgs.gov
cgi_path=cgi-bin/fieldtest.pl

w3m -dump -cols 10000 \
    "http://$server/${cgi_path}?DCPID=$dcpid&SINCE=$hrs" |
    tee @raw |
    awk "/^$dcpid/{print substr(\$1,1,37)}" > .@_header

cmp .@_header @header > /dev/null 2>&1 && {
    echo duplicate DCP header >&2
    exit 1
    }

mv .@_header @header

# w3m -dump -cols 10000 \
#     "http://$server/${cgi_path}?DCPID=$dcpid&SINCE=$hrs" > @raw

# build a descriptor line for heading accumulated raw query results

now=$(date --iso=seconds)

ym=${now%-??T*}

lines=$(wc -l @raw)
lines=${lines% *}

unset user &&
    test -n "$USER" &&
        user="user=$USER"

fields=( $now $server $dcpid qryhrs=$hrs lines=$lines $user )

allraw="@$ym-allraw"

echo "# ${fields[@]}" >> "$allraw"

cat @raw >> "$allraw"

test "@allraw" == "$(readlink $allraw)" ||
    ln -sf $allraw @allraw


